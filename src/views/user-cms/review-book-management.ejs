<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Kode is a Premium Bootstrap Admin Template, It's responsive, clean coded and mobile friendly">
<meta name="keywords" content="bootstrap, admin, dashboard, flat admin template, responsive," />
<title>Trang chủ</title>

<!-- ========== Css Files ========== -->
<%- include('layouts/head') %> 


</head>
<body>
    <!-- Start Page Loading -->
    <%- include('layouts/loading') %> 
    <!-- End Page Loading -->

    <!-- START TOP -->
    <%- include('layouts/header') %> 
    <!-- END TOP -->

    <!-- START SIDEBAR -->
    <%- include('layouts/sidebar') %> 
    <!-- END SIDEBAR -->
    
    <%- include('layouts/notification') %> 

    <!-- START CONTENT -->
    <div class="content">

        <!-- Start Page Header -->
        <div class="page-header">
            <h1 class="title">Danh sách bài review</h1>

            <!-- Start Page Header Right Div -->
            <div class="right">
                <div class="btn-group" role="group" aria-label="...">
                    <a href="/user-cms/book-review/create" class="btn btn-light">Tạo bài mới</a>
                    <a href="/user-cms/book-review" class="btn btn-light"><i class="fa fa-refresh"></i></a>
                    <a href="#" class="btn btn-light"><i class="fa fa-search"></i></a>
                </div>
            </div>
            <!-- End Page Header Right Div -->

        </div>
        <!-- End Page Header -->

        <div class="container-flush">
            
            <div class="row">
                <div class="col-md-12 col-lg-12">
                    <div class="panel panel-default">
                
                        <div class="panel-title">
                            Tìm kiếm
                            <ul class="panel-tools">
                            <li><a class="icon minimise-tool"><i class="fa fa-minus"></i></a></li>
                            <li><a class="icon expand-tool"><i class="fa fa-expand"></i></a></li>
                            <li><a class="icon closed-tool"><i class="fa fa-times"></i></a></li>
                            </ul>
                        </div>
                
                            <div class="panel-body">
                                <form action="#" method="GET">
                                    <div class="row">
                                        <div class="col-md-12 col-lg-6">
                                            <div class="form-group">
                                                <label for="input1" class="form-label">Tên sách</label>
                                                <input type="text" placeholder="Tên sách" name="book_name" class="form-control" id="input1" value="<%- params.book_name %>">
                                            </div>            
                                        </div>
                                        
                                        <div class="col-md-12 col-lg-6">
                                            <div class="form-group">
                                                <label class="form-label">Thể loại</label>
                                                <select class="form-control selectpicker" name="category" multiple data-live-search="true">
                                                    <% bookCategories.forEach(category => { %>
                                                        <option value="<%- category._id %>" <%- params.category && params.category.includes(category._id.toString()) && 'selected' %> ><%- category.name %></option>
                                                    <% }) %>                                                    
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-12 col-lg-6">
                                            <fieldset>
                                                <div class="control-group">
                                                    <label for="input1" class="form-label">Từ ngày</label>
                                                    <div class="controls">
                                                        <div class="input-prepend input-group">
                                                            <span class="add-on input-group-addon"><i class="fa fa-calendar"></i></span>
                                                            <input type="text" id="date-picker" name="date_from" class="form-control" placeholder="dd/mm/yyyy" value="<%- params.date_from %>"/> 
                                                        </div>
                                                    </div>
                                                </div>
                                            </fieldset>
                                        </div>
                                        
                                        <div class="col-md-12 col-lg-6">
                                            <fieldset>
                                                <div class="control-group">
                                                    <label for="input1" class="form-label">Từ ngày</label>
                                                    <div class="controls">
                                                        <div class="input-prepend input-group">
                                                            <span class="add-on input-group-addon"><i class="fa fa-calendar"></i></span>
                                                            <input type="text" id="date-picker-2" name="date_to" class="form-control" placeholder="dd/mm/yyyy" value="<%- params.date_to %>"/> 
                                                        </div>
                                                    </div>
                                                </div>
                                            </fieldset>
                                        </div>
                                    </div>
                                
                                    <div class="button-container mt-20">
                                        <a href="/user-cms/book-review" class="btn">Hủy</a>
                                        <button type="submit" class="btn btn-default">Tìm kiếm</button>
                                    </div>
                                </form>
                
                            </div>
                
                    </div>
                </div>
            </div>
            <div class="row">
                <!-- Start Panel -->
                <div class="col-md-12">
                    <div class="panel panel-default">
            
                        <div class="panel-title">
                            Danh sách <span class="label label-default"><%- totalBooks %></span>
                        </div>
                
                        <div class="panel-body">
                
                            <div class="table-responsive">
                                <table class="table table-bordered table-striped">
                                    <thead>
                                        <tr>
                                            <td>Tên</td>
                                            <td>Slug</td>
                                            <td>Thể loại</td>
                                            <td>Trạng thái</td>
                                            <td>Ngày đăng</td>
                                            <td>Chức năng</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% bookPage.data.forEach(book => { %>
                                            <tr>
                                                <td><%- book.book_name %></td>
                                                <td><%- book.slug %></td>
                                                <td style="width: 150px">
                                                    <% book.category.forEach(cate => { %>
                                                        <span class="label <%- cate.tag_color %>"><%- cate.short_name %></span>
                                                    <% }) %>
                                                </td>
                                                <td>
                                                    <span class="label <%- book.isConfirm? 'label-success': 'label-warning' %>"><%- book.isConfirm? 'Đã duyệt': 'Chờ duyệt' %></span>
                                                    <% if (book.hide) { %>
                                                        <span class="label label-danger">Đã ẩn</span>
                                                    <% } %>
                                                </td>
                                                <td class="datetime <%- book._id %>" style="width: 125px;"><%- book.createdAt %></td>
                                                <td>
                                                    <a href="/user-cms/book-review/create?id=<%- book._id %>" class="view-icon margin-r-5"><i class="fa fa-eye"></i></a>
                                                    <a onclick="confirmBeforeHide('<%- book._id %>', '<%- book.hide %>')" class="hide-icon margin-r-5"><i class="fa fa-ban"></i></a>
                                                    <a onclick="confirmBeforeDelete('<%- book._id %>')" class="delete-icon margin-r-5"><i class="fa fa-times"></i></a>
                                                </td>
                                            </tr>
                                        <% }) %>
                                    </tbody>
                                </table>
                                
                                <%- include('layouts/pagination', {
                                    data: bookPage,
                                    pageLink: '/user-cms/book-review'+link,
                                }) %> 
                            </div>
                        </div>
            
                    </div>
                </div>
                <!-- End Panel -->
            </div>
        </div>
    </div>
    <!-- End Content -->


<%- include('layouts/javascript') %> 

<script>
    
    $(document).ready(function() {
        moment.locale('vi');
    
        let books = '<%- bookPage.data.map(item => item._id) %>';

        books.split(',').forEach(book => {
            let time = $('.datetime.'+book).html();
            $('.datetime.'+book).text(moment(new Date(time)).format('lll'));        
        })
    })
    
    async function confirmBeforeHide(id, status) {
        cuteAlert({
            type: "question",
            title: status === 'true'?"Bỏ ẩn":"Ẩn",
            message: status === 'true'?"Bạn có muốn bỏ ẩn bài này?": "Bạn có muốn ẩn bài này không?",
            confirmText: "Đồng ý",
            cancelText: "Hủy"
        }).then(async e => {
            if(e) {
                fetch('/user-cms/book-review', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        // 'Accept': 'application/json',
                    },
                    body: JSON.stringify({ id })
                })
                    .then(response => response.json())
                    .then(data => {
                        if(!data.error) {
                            cuteToast({
                                type: "success", // or 'info', 'error', 'warning'
                                message: data.message,
                                timer: 5000
                             });
                             document.location.reload(true);
                        } else {
                            cuteToast({
                                type: "error", // or 'info', 'error', 'warning'
                                message: data.message,
                                timer: 5000
                            });
                        }
                    })
                    .catch(err => {
                        cuteToast({
                            type: "error", // or 'info', 'error', 'warning'
                            message: data.message,
                            timer: 5000
                        });
                    });
            }
        })
    }

    async function confirmBeforeDelete(id) {
        cuteAlert({
            type: "question",
            title: "Xóa",
            message: "Bạn có muốn bài này không?",
            confirmText: "Đồng ý",
            cancelText: "Hủy"
        }).then(async e => {
            if(e) {
                fetch('/user-cms/book-review', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        // 'Accept': 'application/json',
                    },
                    body: JSON.stringify({ id })
                })
                    .then(response => response.json())
                    .then(data => {
                        if(!data.error) {
                            cuteToast({
                                type: "success", // or 'info', 'error', 'warning'
                                message: data.message,
                                timer: 5000
                             });
                             document.location.reload(true);
                        } else {
                            cuteToast({
                                type: "error", // or 'info', 'error', 'warning'
                                message: data.message,
                                timer: 5000
                            });
                        }
                    })
                    .catch(err => {
                        cuteToast({
                            type: "error", // or 'info', 'error', 'warning'
                            message: data.message,
                            timer: 5000
                        });   
                    });
            }
        })
    }
</script>

</body>
    
</html>